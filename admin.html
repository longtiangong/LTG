<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>龍天宮 管理版</title>
<style>
body{font-family:"Microsoft JhengHei",Arial,sans-serif;padding:20px;background:#f9f9f9;}
h1{text-align:center;color:#8B0000;}
table{border-collapse:collapse;width:100%;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#f2f2f2;}
button{padding:10px 15px;margin:10px 5px;font-size:16px;}
</style>
</head>
<body>
<h1>龍天宮 管理版報名資料</h1>

<table id="registrationTable">
<thead>
<tr>
<th>姓名</th><th>活動</th><th>光明燈類型</th><th>金額</th><th>新人</th><th>備註</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="stats" style="margin-top:20px;">
<strong>統計：</strong><br>
光明燈人數：<span id="lightCount">0</span> 人，總額 <span id="lightTotal">0</span> 元<br>
太歲人數：<span id="taiSuiCount">0</span> 人，總額 <span id="taiSuiTotal">0</span> 元<br>
祭改人數：<span id="jiGaiCount">0</span> 人，總額 <span id="jiGaiTotal">0</span> 元<br>
新人數量：<span id="newCount">0</span> 人<br>
總金額：<span id="grandTotal">0</span> 元
</div>

<button onclick="exportCSV()">匯出 CSV</button>

<script>
// Google Sheets API
const SHEET_ID = "你的 Google Sheet ID";
const API_KEY = "你的 API Key";
const SHEET_NAME = "工作表1";

function fetchData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
  fetch(url)
  .then(res=>res.json())
  .then(data=>{
    const rows = data.values.slice(1); // 去掉標題
    const tbody = document.querySelector("#registrationTable tbody");
    tbody.innerHTML = "";
    let stats={light:0,taiSui:0,jiGai:0,newCount:0,total:0,lightTotal:0,taiSuiTotal:0,jiGaiTotal:0};

    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td>`;
      tbody.appendChild(tr);

      const amount = Number(r[3]);
      stats.total += amount;
      if(r[1]==="光明燈"){ stats.light++; stats.lightTotal += amount; }
      if(r[1]==="太歲"){ stats.taiSui++; stats.taiSuiTotal += amount; }
      if(r[1]==="祭改"){ stats.jiGai++; stats.jiGaiTotal += amount; }
      if(r[4]==="是") stats.newCount++;
    });

    document.getElementById("lightCount").innerText = stats.light;
    document.getElementById("lightTotal").innerText = stats.lightTotal;
    document.getElementById("taiSuiCount").innerText = stats.taiSui;
    document.getElementById("taiSuiTotal").innerText = stats.taiSuiTotal;
    document.getElementById("jiGaiCount").innerText = stats.jiGai;
    document.getElementById("jiGaiTotal").innerText = stats.jiGaiTotal;
    document.getElementById("newCount").innerText = stats.newCount;
    document.getElementById("grandTotal").innerText = stats.total;
  });
}

// 匯出 CSV
function exportCSV(){
  const rows = document.querySelectorAll("#registrationTable tbody tr");
  let csv="姓名,活動,光明燈類型,金額,新人,備註\n";
  rows.forEach(tr=>{
    const cols=tr.querySelectorAll("td");
    csv += Array.from(cols).map(td=>td.innerText).join(",") + "\n";
  });
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="報名資料.csv";
  link.click();
}

fetchData();
</script>
</body>
</html>
